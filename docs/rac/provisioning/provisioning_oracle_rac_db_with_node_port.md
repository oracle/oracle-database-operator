# Provisioning an Oracle RAC Database with Node Port Services

#### Use Case
* In this use case, the Oracle Grid Infrastructure and Oracle RAC Database are deployed automatically using Oracle RAC Controller. The responsefile is generated by the Oracle RAC Controller based on the input parameters specified in the .yaml file. 
* In this case, the Oracle RAC Database is deployed with Node Port Service for SCAN Listener, Local Listener and the ONS. 
* A node port exposes the service on a static port on the worker node IP address and NodePorts are in the 30000-32767 range by default. 
* This example uses `racdb_prov_np.yaml` to provision an Oracle RAC Database using Oracle RAC Controller. The provisioning includes:
  * 2 Kubernetes Pods as the RAC Nodes
  * Headless services for RAC
    * VIP Service
    * Scan Service
    * RAC Node hostname
  * Shared Persistent volumes created automatically based on specified shared disks for RAC shared storage(ASM)
  * Software Persistent Volumes and Staged Software Persistent Volumes using the specified location on the corresponding worker nodes
  * Namespace: `rac` 
  * Staged Software location on the worker nodes is specified by `hostSwStageLocation`. Grid Infrastructure and RDBMS Binaries are copied to this location on the worker nodes. 
  * Software location on the worker nodes is specified by `racHostSwLocation`. The GI HOME and the RDBMS HOME in the Oracle RAC Pods will be mounted using this location on the corresponding worker node. 


### In this example, 
  * A pre-built Oracle RAC Database slim image available on Oracle OCIR i.e. `phx.ocir.io/intsanjaysingh/db-repo/oracle/database-rac:19.3.0-slim` is used. 
  * If you plan to build the image yourself, you can build using the files from this [GitHub location](https://github.com/oracle/docker-images/tree/main/OracleDatabase/RAC/OracleRealApplicationClusters#building-oracle-rac-database-container-slim-image). In this case, you will need to change value of `image` with the image you have built in your enviornment in file `racdb_prov_np.yaml`. 
  * The ASM diskgroup is configured using the shared disks on the worker nodes i.e. `/dev/disk/by-partlabel/qck-ocne19-asmdisk1` and `/dev/disk/by-partlabel/qck-ocne19-asmdisk2`. These disks are specified using parameter `asmDiskGroupDetails` in the YAML file. 
  * Base Node Port for ONS is specified using parameter `baseOnsTargetPort`. 
  * Base Node Port for Database Local Listener is specified using parameter `baseLsnrTargetPort` 
  * Node Port for Scan Listener is specified using parameter `scanSvcTargetPort` 

### Steps: Deploy 2 Node Oracle RAC Database  
Use the file: [racdb_prov_np.yaml](./racdb_prov_np.yaml) for this use case as below:

1. Deploy the `racdb_prov_np.yaml` file:
    ```sh
    kubectl apply -f racdb_prov_np.yaml
    ```
2. Check the status of the deployment:
    ```sh
    # Check the status of the Kubernetes Pods:    
    kubectl get all -n rac
    
    # Check the logs of a particular pod. For example, to check status of pod "racnode1-0":    
    kubectl exec -it pod/racnode1-0 -n rac -- bash -c "tail -f /tmp/orod/oracle_db_setup.log"
    ===================================
    ORACLE RAC DATABASE IS READY TO USE
    ===================================
    ```
3. Check the End Point and Node Port Service details:
    ```sh
    # Check the End Points:
    kubectl get ep -n rac

    # Check the Node Port Service details:
    kubectl get all -n rac -o wide
    kubectl describe service/racnode-scan-lsnr -n rac
    kubectl describe service/racnode1-0-lsnr -n rac
    kubectl describe service/racnode2-0-lsnr -n rac
    kubectl describe service/racnode1-0-ons -n rac
    kubectl describe service/racnode2-0-ons -n rac
    ```
4. Samples logs in [Logs](./logs/racdb_prov_np/racdbprov-sample_details.txt) and the corresponding [DB Operator Logs](./logs/racdb_prov_np/operator_logs.txt) when the above YAML file is applied. 
