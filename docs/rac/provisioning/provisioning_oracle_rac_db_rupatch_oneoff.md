# Provisioning an Oracle RAC Database with RU Patch and One Offs

#### Use Case
* In this use case, the Oracle Grid Infrastructure and Oracle RAC Database are deployed automatically using Oracle RAC Controller. The responsefile is generated by the Oracle RAC Controller based on the input parameters specified in the .yaml file. 
* In this use case, before the installation, the GRID HOME and RDBMS HOME are patched with the provided RU Patch and One Off Patches. 
* This example uses `racdb_prov_rupatch_and_oneoff.yaml` to provision an Oracle RAC Database using Oracle RAC Controller. The provisioning includes:  
  * 2 Kubernetes Pods as the RAC Nodes
  * Headless services for RAC
    * VIP Service
    * Scan Service
    * RAC Node hostname
  * Shared Persistent volumes created automatically based on specified shared disks for RAC shared storage(ASM)
  * Software Persistent Volumes and Staged Software Persistent Volumes using the specified location on the corresponding worker nodes
  * Namespace: `rac` 
  * Staged Software location on the worker nodes is specified by `hostSwStageLocation`. Grid Infrastructure and RDBMS Binaries are copied to this location on the worker nodes. 
  * Software location on the worker nodes is specified by `racHostSwLocation`. The GI HOME and the RDBMS HOME in the Oracle RAC Pods will be mounted using this location on the corresponding worker node. 
  * Directory where the Release Update (RU) patch has been unzipped is specified by `ruPatchLocation`.
    + For Example: To apply the 19.28 RU Patch `37957391`, if you have unzipped the RU Patch .zip file `p37957391_190000_Linux-x86-64.zip` to location `/scratch/software/stage/19c/19.28/RU` on the worker node, then set this parameter `ruPatchLocation` to value `/scratch/software/stage/19c/19.28/RU/37957391`. 
  * Directory, where latest opatch zip file is available, is specified by `oPatchLocation`.
  * Directory, where unzipped One-off patch files are available, is specified by `oneOffLocation`.
  * Specify Comma-separated one-off patch IDs to be applied to the GI HOME using `gridOneOffIds`. For Example: gridOneOffIds: "38336965,34436514"
  * Specify Comma-separated one-off patch IDs to be applied to the RDBMS HOME using `dbOneOffIds`. For Example: dbOneOffIds: "38336965,34436514"

### In this example, 
  * A pre-built Oracle RAC Database slim image available on Oracle OCIR i.e. `phx.ocir.io/intsanjaysingh/db-repo/oracle/database-rac:19.3.0-slim` is used. 
  * If you plan to build the image yourself, you can build using the files from this [GitHub location](https://github.com/oracle/docker-images/tree/main/OracleDatabase/RAC/OracleRealApplicationClusters#building-oracle-rac-database-container-slim-image). In this case, you will need to change value of `image` with the image you have built in your enviornment in file `racdb_prov_rupatch_and_oneoff.yaml`. 
  * The ASM diskgroup is configured using the shared disks on the worker nodes i.e. `/dev/disk/by-partlabel/qck-ocne19-asmdisk1` and `/dev/disk/by-partlabel/qck-ocne19-asmdisk2`. These disks are specified using parameter `asmDiskGroupDetails` in the YAML file.   

  
### Steps: Deploy 2 Node Oracle RAC Database with RU Patch and One Offs 
Use the file: [racdb_prov_rupatch_and_oneoff.yaml](./racdb_prov_rupatch_and_oneoff.yaml) for this use case as below:

1. Deploy the `racdb_prov_rupatch_and_oneoff.yaml` file:
    ```sh
    kubectl apply -f racdb_prov_rupatch_and_oneoff.yaml
    ```
2. Check the status of the deployment:
    ```sh
    # Check the status of the Kubernetes Pods:    
    kubectl get all -n rac

    # Check the logs of a particular pod. For example, to check status of pod "racnode1-0":    
    kubectl exec -it pod/racnode1-0 -n rac -- bash -c "tail -f /tmp/orod/oracle_db_setup.log"
    ===================================
    ORACLE RAC DATABASE IS READY TO USE
    ===================================
    ```
3. Samples logs in [Logs](./logs/racdb_prov_rupatch_oneoffs/racdbprov-sample_details.txt) and the corresponding [DB Operator Logs](./logs/racdb_prov_rupatch_oneoffs/operator_logs.txt) when the above YAML file is applied. 